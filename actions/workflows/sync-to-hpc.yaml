version: "2.0" # mistral version
name: umccr.sync2hpc
description: Data sync to HPC workflow

workflows:
  main:
    type: direct
    input:
      - source_path
      - runfolder_name
      - excludes
      - dest_host
      - dest_path
      - rsync_ssh_user
    output:
      output_the_whole_workflow_context: "{{ _.state }}"

    tasks:
      # Notify of workflow start
      post_runfolder:
        action: chatops.post_message
        input:
          channel: "{{ st2kv.system.slack.channel }}"
          message: "Starting rsync of *{{ _.runfolder_name }}*"
        on-success:
          - rsync_to_destination


      # sync the data to the HPC
      rsync_to_destination:
        action: core.remote
        input:
          cmd: 'rsync -avzh --append-verify {{ _.excludes }} {{ _.source_path }} -e "ssh" {{ _.rsync_ssh_user }}@{{ _.dest_host }}:{{ _.dest_path }}/Fastq/{{ _.runfolder_name }}'
          hosts: "{{ st2kv.system.novastor.ssh.host }}"
          port: "{{ st2kv.system.novastor.ssh.port }}"
          username: "{{ st2kv.system.novastor.ssh.user }}"
          private_key: "{{ st2kv.system.novastor.ssh.key.path }}"
          timeout: 21600 # 6 hour timeout
        retry: # retry the command 3 times with 30sec delay in case of error, then fail
          count: 3
          delay: 30
        on-success:
          - post_rsync_success
          - create_ready_link
        on-error:
          - post_rsync_failure

      post_rsync_success:
        action: chatops.post_message
        input:
          channel: "{{ st2kv.system.slack.channel }}"
          message: "Runfolder *{{ _.runfolder_name }}* successfuly synced to {{ _.dest_host }}"
        publish: # publish a successfull state
          state: "0"

      post_rsync_failure:
        action: chatops.post_message
        input:
          channel: "{{ st2kv.system.slack.channel }}"
          message: "ERROR: Runfolder *{{ _.runfolder_name }}* sync failed!"
        publish: # publish an unsuccessfull state, so the workflow is terminated here
          state: "-1"


      # create the symlink in the Ready folder as flag that the data in now in place and ready to be used
      create_ready_link:
        action: core.remote
        input:
          cmd: "ssh {{ _.rsync_ssh_user }}@{{ _.dest_host }} 'ln -sf {{ _.dest_path }}/Fastq/{{ _.runfolder_name }} {{ _.dest_path }}/Ready/{{ _.runfolder_name }}'"
          hosts: "{{ st2kv.system.novastor.ssh.host }}"
          port: "{{ st2kv.system.novastor.ssh.port }}"
          username: "{{ st2kv.system.novastor.ssh.user }}"
          private_key: "{{ st2kv.system.novastor.ssh.key.path }}"
          timeout: 43200
        on-success:
          - post_ready_link_success
          - update_group: "{{ _.dest_host == 'spartan.hpc.unimelb.edu.au' }}"
        on-error:
          - post_ready_link_failure

      post_ready_link_success:
        action: chatops.post_message
        input:
          channel: "{{ st2kv.system.slack.channel }}"
          message: "Runfolder *{{ _.runfolder_name }}* successfuly flagged as _ready_."
        publish:
          state: "0"

      post_ready_link_failure:
        action: chatops.post_message
        input:
          channel: "{{ st2kv.system.slack.channel }}"
          message: "ERROR: Could not create symlink for *{{ _.runfolder_name }}*!"
        publish:
          state: "-1"


      update_group:
        action: core.remote
        input:
          cmd: "ssh {{ _.rsync_ssh_user }}@{{ _.dest_host }} 'chown -R :punim0010 {{ _.dest_path }}/Fastq/{{ _.runfolder_name }} {{ _.dest_path }}/Ready/{{ _.runfolder_name }}'"
          hosts: "{{ st2kv.system.novastor.ssh.host }}"
          port: "{{ st2kv.system.novastor.ssh.port }}"
          username: "{{ st2kv.system.novastor.ssh.user }}"
          private_key: "{{ st2kv.system.novastor.ssh.key.path }}"
          timeout: 43200
        on-success:
          - post_group_update_success

      post_group_update_success:
        action: chatops.post_message
        input:
          channel: "{{ st2kv.system.slack.channel }}"
          message: "Successfully changed user group of *{{ _.runfolder_name }}* to _punim0010_"
        publish:
          state: "0"
