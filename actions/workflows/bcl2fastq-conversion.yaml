version: "2.0" # mistral version
name: umccr.bcl2fastq_conversion
description: The bcl2fastq conversion workflow

workflows:
  main:
    type: direct
    input:
      - runfolder_name
    output:
      output_the_whole_workflow_context: <% $ %>

    tasks:
      # Notify of newly detected runfolder
      post_runfolder:
        action: chatops.post_message
        input:
          channel: "#arteria-dev"
          message: "Launching conversion process for runfolder: <% $.runfolder_name %>"
        on-success:
          - bcl2fastq_conversion


      # Start the bcl2fastq conversion and notify of start
      bcl2fastq_conversion:
        action: core.http
        input:
          url: 'http://172.19.0.1:9999/api/1.0/start/<% $.runfolder_name %>'
          body: '{}'
          method: "POST"
        publish:
          bcl2fastq_job: <% task(bcl2fastq_conversion).result.body.job_id %>
        on-success:
          - bcl2fastq_status
          - post_bcl2fastq_start

      post_bcl2fastq_start:
        action: chatops.post_message
        input:
          channel: "#arteria-dev"
          message: "Runfolder <% $.runfolder_name %> converting (job: <% $.bcl2fastq_job %>)."
          # TODO add alias to allow querying for the status (then add command to message)


      # Monitor the conversion status and notify of success/failure
      bcl2fastq_status:
        action: core.http
        wait-before: 300 # check for status updates every 5min
        input:
          url: 'http://172.19.0.1:9999/api/1.0/status/<% $.bcl2fastq_job %>'
          method: "GET"
        publish:
          bcl2fastq_status: <% task(bcl2fastq_status).result.body.state %>
        on-success:
          - bcl2fastq_status: "<% $.bcl2fastq_status = 'pending' %>"
          - bcl2fastq_status: "<% $.bcl2fastq_status = 'started' %>"
          - post_bcl2fastq_success: "<% $.bcl2fastq_status = 'done' %>"
          - post_bcl2fastq_error: "<% $.bcl2fastq_status = 'error' %>"

      post_bcl2fastq_success:
        action: chatops.post_message
        input:
          channel: "#arteria-dev"
          message: "Runfolder <% $.runfolder_name %> (job: <% $.bcl2fastq_job %>) successfully converted."

      post_bcl2fastq_error:
        action: chatops.post_message
        input:
          channel: "#arteria-dev"
          message: "Runfolder <% $.runfolder_name %> (job: <% $.bcl2fastq_job %>) errored."
